---
layout: post
title: redis持久化技术
category: blog
description: 总结redis集群的搭建和使用技术
---

## Redis持久化方案

### 快照持久化(snapshoting)

### 只追加文件(append-only file)

## 事务

所谓的事务是指一组必须同时顺序执行的操作，如果一个操作执行失败，则所有的操作将回滚
一定要分析好具体业务场景，才决定是否使用事务提交
在Redis中，默认的单个操作是谈不上什么事务的, 而在Mysql中默认每个提交都是事务级别的(autocommit)
Redis使用的是流水线事务，即多个操作会延迟执行，客户端最终会批量提交所有的操作，这些操作在执行之前需要
客户端程序主动添加对竞争资源的watch，它是一个乐观锁, 多个客户端可以同时获取该锁.
Redis的事务需要以下操作配合:watch multi exec
watch: 添加对竞争资源的监控
multi: 开始一个事务操作
exec: 批量提交从multi到exec的所有操作给服务器
在exec执行之前，只要watch的竞争资源发生更改，就会抛出错误异常，客户端可以选择重试或者放弃事务
redis是顺序执行exec提交的一系列命令的，永远不会出现一个客户端在执行exec提交的命令时被其他的
客户端打断的现象

### Redis事务错误

Redis在事务处理中会遇到两种错误，按照错误时机来分有exec执行之前和之后两种，还有一种是事务执行
过程中，整个服务器出现了宕机

1. exec执行之前

exec执行之前是将所有的操作加入到执行队列queue，如果这是检查到命令使用错误，例如某个命令
的使用参数不全，则exec就不会执行;
这种错误不致命，不会产生什么影响，客户端可以做这种类型的错误监控

2. exec执行之后

在exec执行之后，服务器批量执行所有的命令。但是如果这时有个处于中间位置的命令执行出错,
例如错误的集合类型不对(对每个string集合使用了list集合的命令)，它不会回滚之前做的任何正确执行的操作,
而且不会阻断之后的操作. 这样的错误就比较致命了，它会造成数据不一致现象。

3. 服务器宕机

当采用aof持久化方案同步数据到磁盘时，只有事务的部分操作注册到了aof文件中，这时可以使用
redis-aof-check命令来检查aof文件的完整性，它可以检测并去除不完整的事务操作记录。

### Redis事务 VS Mysql事务

在Redis主要用来做缓存的使用场景下，一般用不到事务

Redis的watch是一种乐观锁，它只会在数据被其他客户端抢先修改的情况下通知执行了这个命令
的客户端，而不会阻止其他客户端对数据修改

Mysql中的事务锁是悲观锁, 当一个客户端获取了锁后，其他的客户端必须等待
Redis事务不提供回滚机制，不能保证数据一致性，不靠谱

### Redis不提供回滚机制的理由

1. Redis出错主要原因在于开发人员

上面总结的三种事务错误中，前两种都是由开发人员使用Redis操作不正确造成的，这些语法错误
本身在开发阶段就可以被发现，因此不会蔓延到生产环境
回滚机制解决不了开发人员的错误, 本身就是用了错误的Redis操作，即使回滚也解决不了实际问题

2. Redis追求简单和快速

### Watch操作

Watch操作用来监控exec执行前的竞态条件是否满足，它使用原子性的CAS操作和访问竞态资源，
与直接对竞态资源加锁的手段相比，这种方式大大提高了效率

